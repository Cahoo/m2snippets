# Magento 2 EAV модель

Аббревиатура EAV раскрывается как Entity-Attribute-Value (это для тех, кто не ходил по ссылке выше). 
Основным преимуществом EAV является эффективное использование пространства БД в тех случаях, когда возможное количество различных атрибутов (свойств, параметров), 
которые могут быть использованы для описания вещей (сущностей), является очень широким, но количество атрибутов, которое на самом деле относится к отдельному объекту, 
является относительно небольшим. Хорошим примером подобного случая в e-commerce служит такое понятие, как "продукт" — значимые атрибуты продуктов "телевизор" (размер экрана) отличаются от значимых атрибутов продуктов "спальный мешок" (минимальная комфортная температура).

Понятия EAV модели:

1. 'eav_' namespace

В свежеразвёрнутой базе Magento есть 21 таблица с префиксом eav_. Все их можно разделить на три группы:

- eav_attribute
- eav_entity
- eav_form

Проще всего с eav_form — эти таблицы относятся к отображению некоторых EAV-данных на UI и непосредственно к размещению EAV-данных в базе не относятся.
Из оставшихся двух группа eav_attribute относятся к букве A(ttribute), а группа eav_entity — к букве E(ntity).

Значения для атрибутов сущностей находятся в суффиксах имён таблиц:

- _datetime
- _decimal
- _int
- _text
- _varchar

Подобные суффиксы имеются у таблиц, начинающихся с:

- catalog_category_entity_
- catalog_product_entity_
- customer_address_entity_
- customer_entity_
- eav_entity_

Перемножение количества суффиксов (5) на кол-во префиксов (5) даёт нам общее кол-во таблиц (25) в которых предполагается хранение values-данных.

2. 'eav_entity_type': реестр типов сущностей

Начало EAV в Magento нужно искать в таблице eav_entity_type. 
Именно здесь задаётся, для каких типов сущностей значения атрибутов будут сохранятся в EAV-структуре. 
Изначально Magento 2 предлагает такой вариант для следующих восьми сущностей:

- customer
- customer_address
- catalog_category
- catalog_product
- order
- invoice
- creditmemo
- shipment

3. 'eav_attribute': реестр атрибутов

Следующий шаг — находим, какими атрибутами могут характеризоваться эти типы сущностей. Данная информация находится в таблице eav_attribute. Реестр атрибутов имеет замыкание на реестр типов сущностей по внешнему ключу (foreign key). В реестре атрибутов изначально 135 записей, принадлежащих 4 типам сущностей:

- customer
- customer_address
- catalog_category
- catalog_product

Остальные типы сущностей: order, invoice, creditmemo, shipment не используют EAV-структуру для хранения данных.

4. Таблицы, начинающиеся с 'eav_entity_'.

Пространство таблиц eav_entity состоит из 9 таблиц пространства, но данные содержатся только в двух:

- eav_entity_type - это реестр типов сущностей;
- eav_entity_attribute - используется для упорядочивания атрибутов в группах (ближе к отображению данных, чем к их хранению); данная информация больше относится непосредственно к самим атрибутам, чем к сущностям.

Остальные 7 таблиц — пусты:

- eav_entity
- eav_entity_datetime
- eav_entity_decimal
- eav_entity_int
- eav_entity_store
- eav_entity_text
- eav_entity_varchar

###Типы значений атрибутов

В таблице eav_entity_type задаются типы сущностей, в таблице eav_attribute задаются сами атрибуты и их привязка к соответствующим типам сущностей. 
А как определить, где искать значение для такого-то атрибута такой-то сущности?

В этом нам поможет поле eav_attribute.backend_type. Оно показывает, где сохраняются значения атрибутов: static -  в таблице с данными о самой сущности 
(например, значения для атрибута #9 — customer.email, нужно искать в таблице клиентов customer_entity в столбце email).
Для остальных типов значения сохраняются в отдельных таблицах, в названиях, которых префикс соответствует типу сущности (customer_, ...), а суффикс — одному из типов данных:

- datetime
- decimal
- int
- text
- varchar

Т.е., значения для атрибута #79 catalog_product.special_from_date типа datetime сохраняются в таблице catalog_product_entity_datetime. 
Значения для атрибута #77 catalog_product.price — в таблице catalog_product_entity_decimal.

Что можно интересного увидеть в таблице eav_attribute в связи с типами значений? Как я уже отмечал выше, в данной таблице описаны атрибуты только для 4 типов сущностей из 8, зарегистрированных в eav_entity_type. При этом для сущностей типа customer и customer_address все атрибуты, определённые изначально, имеют тип значений static — т.е., являются обычными колонками в таблице и никак не используют преимуществ EAV-подхода. Таблицы:

- customer_entity_datetime
- customer_entity_decimal
- customer_entity_int
- customer_entity_text
- customer_entity_varchar
- customer_address_entity_datetime
- customer_address_entity_decimal
- customer_address_entity_int
- customer_address_entity_text
- customer_address_entity_varchar

Эти таблицы изначально пусты и могут быть использованы только программным путём (т.е., через админку, без сторонних расширений, нет возможности записать что-либо в эти таблицы).

###EAV для категорий

Категории каталога — вот первая сущность, которая более-менее использует EAV подход в Magento. Тип сущности — catalog_category, всего изначальных атрибутов — 30, из которых не-статических — 26. То есть, значения только 4 атрибутов (children_count, level, path, position) сохраняются в таблице catalog_category_entity, остальные сохраняются в наборе таблиц catalog_category_entity_ [ datetime | decimal | int | text | varchar ].

Структура таблиц из этого набора очень похожа как друг на друга, так и на аналогичные таблицы других типов сущностей (клиентов, их адресов и т.д.):

```
CREATE TABLE `catalog_category_entity_datetime` (
  `value_id` int(11) NOT NULL AUTO_INCREMENT,
  `attribute_id` smallint(5) unsigned NOT NULL DEFAULT '0',
  `store_id` smallint(5) unsigned NOT NULL DEFAULT '0',
  `entity_id` int(10) unsigned NOT NULL DEFAULT '0',
  `value` datetime DEFAULT NULL,
  PRIMARY KEY (`value_id`),
  UNIQUE KEY `...` (`entity_id`,`attribute_id`,`store_id`),
  ...
) ...
```

Для различных типов сохраняемых значений (datetime, decimal, int, text, varchar) меняется только тип колонки value. Данная структура позволяет сохранять отдельное значение (value) отдельного атрибута (attribute_id) отдельной сущности (entity_id) для отдельной витрины (store_id).

###EAV для продуктов

Это тот самый тип сущностей, ради которого EAV и затевалась в Magento. Тип сущности — catalog_product, всего изначальных атрибутов — 63, из которых не-статических — 56. Структура таблиц, поддерживающих EAV для продуктов, аналогична структуре таблиц для каталогов. Но есть одно значительное отличие. Для продуктов можно создавать новые атрибуты через админку — это default'овый функционал Magento, из коробки. Если для других сущностей Magento предоставляет только EAV структуры данных в расчёте на их программное заполнение, то для продуктов реализован интерфейс, позволяющий делать это на уровне пользователя (управляющего магазином) — Stores / Attributes / Product.
Для продуктов задействованы ещё две таблицы, относящиеся к EAV:

- eav_attribute_set
- eav_attribute_group

По-большому счёту, они скорее относятся к отображению информации, чем к её хранению. 
Атрибуты продукта объединяются в наборы (set) и при создании продукта ему присваивается набор атрибутов, что позволяет при заполнении карточки продукта для, например, 
телевизора, выбирать набор атрибутов, относящийся именно к бытовой технике (или даже для группы продуктов "телевизоры"). 
Объединение атрибутов в наборы происходит в Stores / Attributes / Product / Attribute Set.
