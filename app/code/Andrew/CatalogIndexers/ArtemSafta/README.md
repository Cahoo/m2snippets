#Демонстрация и понимание каталог индексеров

Фрэймворк Индексации, ценовой индексер, индексер инвентаря, eav индексер. 
Как M2 использует проиндексированные данные?

Индексеры декларируются в etc/indexer.xml.
Пример декларации:

```
<indexer id="catalog_product_price" view_id="catalog_product_price" class="Magento\Catalog\Model\Indexer\Product\Price">
    <title translate="true">Product Price</title>
    <description translate="true">Index product prices</description>
</indexer>
```

Вы можете сконфигурировать индексер, чтобы он зависел от другого индексера используя ноду
`dependencies`

```
 <indexer id="catalog_product_price">
        <dependencies>
            <indexer id="catalogrule_rule" />
        </dependencies>
    </indexer>
```

Список индексеров можно получить с помощью коллекции
`\Magento\Indexer\Model\Indexer\Collection`. Если вам необходимо добавить добавить индексер
и добавить условие при котором он будет включён. Например если модуль включён. Вам необходимо
добавить плагин на `\Magento\Indexer\Model\Indexer\Collection::getItems` метод.

#Практическое задание

- Создать phpStorm PHP Script debug configuration для выполнения этой команды
`bin/magento indexer:reindex catalog_product_price`
- Добавить точку останова на первой строке 
  `\Magento\Indexer\Console\Command\IndexerReindexCommand::execute`
  

Индексеры представлены классом `\Magento\Indexer\Model\Indexer`. В этом классе есть 
три метода для обновления индексеров `reindexAll`, `reindexRow` и `reindexList`.

В каждом методе используется сущность, которая реализует \Magento\Framework\Indexer\ActionInterface
Должны быть реализованы такие методы `executeFull()`, `executeList(array $ids)`, `executeRow($id)`

```
Слишком частый запуск индексации может повлиять на пользовательский интерфейс. 
Цены могут быть отображаться 0, например в момент загрузки страницы, 
когда новые индексы цен вставляются в таблицу индексов цен.
```

#Индексер цены

Индексация цены определяют самую низкую цену среди `(price, special price, tier price, catalog price rules)`
Данные сохраняются в `catalog_product_index_price`.

Индексер цены перебирает в цикле модель индексации `(indexerModel)` для каждого типа продуктов.
Эти сущности должны реализовывать `\Magento\Framework\Indexer\DimensionalIndexerInterface`

Php процесс разветвляется во столько дочерних процессов во сколько необходимо.
Для того чтобы запустить реиндексацию многопоточно, необходимо перед запуском параметру 
`MAGE_INDEXER_THREADS_COUNT` присвоить значение 3. Это поможет обеспечить то что 
большой каталог с большим количеством `tiered price` будут индексироваться эффективнее. То есть пока будет
индексация прайсов остальные индексы пройдут.

Индексеры запускаются партиями (смотри `(see \Magento\Framework\Indexer\BatchProvider::getBatches`), 
чтобы предотвратить ошибки связанные с памятью.

`bin/magento indexer:info` эта команда позволяет увидеть список все индексеров
`bin/magento indexer:status` эта команда позволяет увидеть статус всех индексеров

#Практическое задание

 - Поставить точку останова в `\Magento\Catalog\Model\Indexer\Product\Price` для методов
`(reindexAll, reindexRow and reindexList)`. Как вы можете активировать каждый метод?
- Пошаговое руководство по созданию индексов цены.
- Как изменение MAGE_INDEXER_THREADS_COUNT влияет на процесс индексации?
- Установить тоску останова `\Magento\Catalog\Block\Product\ListProduct::initializeProductCollection`
  После этого выполнить метод $collection->getSelect()->__toString(). Можно будет увидеть sql join,
  которые включают в себя индексные таблицы
  

#Индексер инвентаря

Индексер инвентаря определяет количество товаров на складе и доступность товара для заказа.
Главный индексатор для инвентаря `\Magento\CatalogInventory\Model\Indexer\Stock`. Каждая операция индексации
`(full, list, ID)` имеет свой собственный индексирующий класс. Для каждого типа продукта можно указать
свой собственный `stock indexer` в `stockIndexerModel` классе. Это используется в `bundle`, `configurable`, `grouped` 
типах продуктов, потому что из `stock status` зависит от дочерних продуктов.


#EAV индексер

Это используется для объеденения атрибутов для поиска. С добавлением ElasticSearch в Magento 2.3
из коробки. Mysql Search прекращается поддерживаться.

Оценка усилий по кастомизации индексов, при создании архитектурных решений. 
Оценка процесса индексации в плане комплексности и времени отведенного на данные условия.
Влияние индексации еа частое обновление каталога.


Большинство операций индексации объединяют данные со сложными SQL-запросы.
(смотри `\Magento\Catalog\Model\ResourceModel\Product\Indexer\Price\DefaultPrice::getSelect`)

Если индексация происходит часто, то работать со страницами категории становится невозможным.
Это потому что некоторые индексные таблицы очищаются и снова заполняются данными. Если кастомер
находится на странице категории в то время как таблицы пустые, INNER JOIN запросы исключает
результат и пустые списки категории будут кэшироваться с помощью `full-page cache`.

#Какие шаги М2 выполняет при индексации? Какая роль в этом у `indexer_state` таблицы

Шаги, которые выполняет М2 рассмотрены выше.
`indexer_state` таблица хранит состояние индексера. Есть три состояния у индексера
`working`, `valid` и `invalid`

#Как зарегистрировать новый индексер

Деклараться нового индексера происходит с помощью файла `etc/indexer.xml` Ваш индексер должен
реализовывать `\Magento\Framework\Indexer\ActionInterface`

#Как ценвой индексер работает? Какие события вызывает? Как разные типы продуктов декларируют свои индексеры

- Команда `indexer:reindex`
- Крон для строк которые необходимо обновить
- Сохранение продукта
- Массовое обновление продуктов

#Практическое задание
- Установить точку останова `\Magento\Catalog\Model\Indexer\Product\Price::executeRow`
- Сохранить продукт
- Оцените стэк вызовов. Как срабатывает индексер?

#На сколько важен порядок индексеров в индексации цены?
Порядок очень важен. Индексация цены зависит от успешно выполненой индексации `catalogrule`
Иначе эти рулы не повлияют на цену.

#Обзор индексера инвентаря. Индексация для разных типов продуктов.
Это рассмотрено выше.

#К каким scope относится цена и индексация цены? На сколько трудно расширить скоуп индексации?

По умолчанию в М2 цены относятся к global(default) и website scope. Однако для `catalog_product_index_price`
таблица относится website scope.

Изменение на уровне store view увеличит существенно количество точек,
в котором придётся изменять или добавлять поведение. Что касается индексации вам придётся
обновить все индексные таблицы (и запросы, которые заполняют эти таблицы). Это скорее всего
приведёт за собой добавление новых JOIN и параметров запросов.

Модификаторы цены доступны для регулирования единоразово во временных индексных таблицах.
(смотри `\Magento\Catalog\Model\ResourceModel\Product\Indexer\Price\SimpleProductPrice::executeByDimensions`)

Пример запроса:
`\Magento\Catalog\Model\ResourceModel\Product\Indexer\Price\Query\BaseFinalPrice::getQuery`

#Как влияет большое количество сторов и вебсайтов на индексацию цены?

Каждый вебсайт (не магазин) увеличит количество строк в таблице `catalog_product_price_index`
Там есть три колонки, которые участвуют в условии  
`entity_id (product ID), customer_group_id, website_id and tax_class_id.`
Чтобы вычислить число строк в таблице, умножьте количество записей 
для каждой из этих колонок. За исключением `tax class`
Если у вас 2000 продуктов 4 группы кастомеров и 2 вебсайта это будет 16000 строк. Если у вас
3 вебсайта, то 24000 сток.

#Custom price модификаторы: Плюсы и минусы кастомизации индексов по сравнению с настройкой прайс рулов и кастом опций

Каждый раз когда вы избегаете модификации индексов цены вы экономите время на поддержании
Использование рулов и кастом опции чаще всего лучший путь

Преимущества кастомизации индексов в том что поиск цен будет выполняться быстрее. 
Обратная сторона медали больше времени на разработку 
s
Помните индексация цены используется страницы категории и страницы поиска (также в `related/cross-sell/up-sell`) 






